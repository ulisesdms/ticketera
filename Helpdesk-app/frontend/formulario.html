<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Pedidos</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #333;
            padding: 20px;
        }
        
        .container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.8rem;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .buttons-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
    
    
        
        .info-label {
            font-weight: 600;
            width: 150px;
            color: #555;
        }
        
        .info-value {
            flex: 1;
        }
        
        .estado-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .estado-abierto {
            background-color: #3498db;
            color: white;
        }
        
        .estado-proceso {
            background-color: #f39c12;
            color: white;
        }
        
        .estado-cerrado {
            background-color: #2ecc71;
            color: white;
        }
        
        .id-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .id-label {
            font-weight: 600;
            color: #555;
        }
        
        .id-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #3498db;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .estado-selector {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .estado-selector label {
            margin-bottom: 5px;
        }
        
        .btn-actualizar {
            margin-top: 10px;
        }
        
        .db-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 15px;
            background-color: rgba(46, 204, 113, 0.9);
            color: white;
            border-radius: 5px;
            font-size: 0.9rem;
            z-index: 1000;
        }
        
        .sub-equipo-container {
            display: none;
            margin-top: 20px;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .sub-equipo-container.show {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 600px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Pantalla Principal -->
        <div id="mainScreen" class="screen active">
            <h1>Sistema de Gestión de Pedidos</h1>
            
            <div class="buttons-container">
                <button id="nuevoPedidoBtn" class="btn btn-success">Nuevo Pedido de Trabajo</button>
                <button id="buscarPedidoBtn" class="btn btn-primary">Buscar Pedido</button>
            </div>
        </div>
        
        <!-- Pantalla Nuevo Pedido -->
        <div id="nuevoPedidoScreen" class="screen">
            <h1>Nuevo Pedido de Trabajo</h1>
            
            <div class="id-container">
                <span class="id-label">ID del Pedido:</span>
                <span class="id-value" id="pedidoId">80000</span>
            </div>
            
            <form id="pedidoForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="solicitante">Solicitante *</label>
                        <select id="solicitante" name="solicitante" required>
                            <option value="">Seleccionar solicitante</option>
                            <option value="527"> 527   AGUIRRE, DELFOR</option>
                            <option value="541">541   AGUIRRE TELLI, NICOLAS</option>
                            <option value="337">337   AILAN , MARTIN</option>
                            <option value="580">580   ALVAREZ , MYRIAM</option>
                            <option value="333">333   ALVAREZ , FAVIO</option>
                            <option value="559">559   ALVAREZ , RAMON</option>
                            <option value="108">108   ARIAS , ROBERTO</option>
                            <option value="455">455   AMAYA , NAHUEL</option>
                            <option value="546">546   AROSA, ALEJANDRO</option>
                            <option value="57">57    ARGUELLO , EMILIANO</option>
                            <option value="309">309   ARGUELLO , RICARDO</option>
                            <option value="384">384   BAEZ , MATIAS</option>
                            <option value="86">86    BALBUENA , RAMON</option>
                            <option value="43">43    BARCALA , HECTOR</option>
                            <option value="381">381   BARRIENTOS , PEDRO</option>
                            <option value="453">453   BARRIONUEVO , GERMAN</option>
                            <option value="302">302   BENITEZ , JOSE</option>
                            <option value="375">375   BELEN , DAVID</option>
                            <option value="111">111   BERNAL , ALEJANDRO</option>
                            <option value="476">476   BOGARIN , SERGIO</option>
                            <option value="460">460   BAIZ , JONATHAN</option>
                            <option value="235">235   CACERES , GABRIEL</option>
                            <option value="284">284   CACERES , HUGO</option>
                            <option value="461">461   CAMPANA, PABLO</option>
                            <option value="125">125   CANOVA , RUBEN</option>
                            <option value="77">77    CARRIZO , MANUEL</option>
                            <option value="33">33    CASCO, FERNANDO</option>
                            <option value="321">321   CASTRO , LUIS</option>
                            <option value="157">157   CHAIT , PABLO</option>
                            <option value="176">176   CHAPARRO , JUAN</option>
                            <option value="31">31    CHAVEZ, HECTOR</option>
                            <option value="63">63    CHAVEZ , HECTOR</option>
                            <option value="230">230   CORONEL , JORGE</option>
                            <option value="453">453   CRISTANTE , GERMAN</option>
                            <option value="215">215   CURIALE , GUSTAVO</option>
                            <option value="535">535   DAMIANO, HECTOR</option>
                            <option value="567">567   DIARTE, RODOLFO</option>
                            <option value="335">335   DI  MAURO, ROBERTO</option>
                            <option value="70">70    DOMINGUEZ , CARLOS</option>
                            <option value="76">76    DOMINGUEZ , ANGEL</option>
                            <option value="113">113   DOMINGUEZ , ARIEL</option>
                            <option value="261">261   DOMINGUEZ , JOSE</option>
                            <option value="90">90    DERICO , HUGO</option>
                            <option value="451">451   DUARTE , WALTER</option>
                            <option value="425">425   FABBRI , SEBASTIAN</option>
                            <option value="58">58    FERNANDEZ , OSCAR</option>
                            <option value="61">61    FERNANDEZ , RAMON</option>
                            <option value="373">373   FERNANDEZ , NICOLAS</option>
                            <option value="382">382   FERNANDEZ , EMMANUEL</option>
                            <option value="564">564   FERREIRA, LUCAS</option>
                            <option value="62">62    FLORES , VICTOR</option>
                            <option value="519">519   FONSECA , MATIAS</option>
                            <option value="502">502   FONTANA , DANIEL</option>
                            <option value="552">552   FRANCO, CARLOS</option>
                            <option value="366">366   FRANCO , PEDRO</option>
                            <option value="268">268   GAMARRA , MANUEL</option>
                            <option value="100">100   GARNIER , ALFREDO</option>
                            <option value="136">136   GARCIA , CRISTIAN</option>
                            <option value="523">523   GEREZ , DAVID</option>
                            <option value="548">548   GIMENEZ, CRISTIAN</option>
                            <option value="219">219   GODOY , GUSTAVO</option>
                            <option value="55">55    GONZALEZ , MARCELINO</option>
                            <option value="102">102   GONZALEZ, LUIS</option>
                            <option value="254">254   GONZALEZ , LEONEL</option>
                            <option value="521">521   GONZALEZ , LEANDRO</option>
                            <option value="88">88    GOMEZ , GUSTAVO</option>
                            <option value="30">30    GOMEZ, JULIO</option>
                            <option value="50">50    GOMEZ, ISMAEL</option>
                            <option value="47">47    GOMEZ, WALTER</option>
                            <option value="251">251   GUZMANO , JOSE</option>
                            <option value="52">52    GUZMAN , EMILIO</option>
                            <option value="89">89    HERNANDEZ , GUSTAVO</option>
                            <option value="1955">1955   HERMOSID , BAUTISTA</option>
                            <option value="96">96    HERMOSID , CARLOS</option>
                            <option value="363">363   HEINZE , WALTER</option>
                            <option value="208">208   HUMERES , DIEGO</option>
                            <option value="79">79    IBAÑEZ , ENZO</option>
                            <option value="72">72    IÑIGUEZ , FERNANDO</option>
                            <option value="275">275   JUAREZ , MATIAS</option>
                            <option value="32">32    JUAREZ , HECTOR</option>
                            <option value="60">60    KLACZYNSKI , JULIO</option>
                            <option value="467">467   LARRAN , ADRIAN</option>
                            <option value="458">458   LEON ,  ZAMBRANA</option>
                            <option value="325">325   LEONI , CARLOS</option>
                            <option value="158">158   LEMOS , RAUL</option>
                            <option value="569">569   LEMOS, ALEJANDRO</option>
                            <option value="577">577   LEMOS, DIEGO</option>
                            <option value="27">27    LEIVA , WALTER</option>
                            <option value="575">575   LESME, LUCIO</option>
                            <option value="578">578   LUCERO, NANCY</option>
                            <option value="424">424   LUGO , JOSE</option>
                            <option value="87">87    MAIDANA , ROQUE</option>
                            <option value="66">66    MARIN , JUAN</option>
                            <option value="457">457   MARTINEZ , SEBASTIAN</option>
                            <option value="78">78    MENDIETA , MARCELO</option>
                            <option value="590">590   MENDOZA , ULISES</option>
                            <option value="12">12    MESSERE , PASCUAL</option>
                            <option value="180">180   MIGLIAVACA , LUCIANO</option>
                            <option value="216">216   MOHAMED , MATIAS</option>
                            <option value="376">376   MONTENEGRO , LEONARDO</option>
                            <option value="201">201   MOREIRA , RAMON</option>
                            <option value="343">343   NOGALES , ROCHA</option>
                            <option value="401">401   OCHOA , MARIANO</option>
                            <option value="353">353   OCHOA , FERNANDO</option>
                            <option value="114">114   ORUE , FRANCISCO</option>
                            <option value="109">109   ORUE , GERMAN</option>
                            <option value="243">243   ORTIZ , ABEL</option>
                            <option value="144">144   OSSO , DANIEL</option>
                            <option value="532">532   OVELAR, ENRIQUE</option>
                            <option value="92">92    PALAVECINO , OMAR</option>
                            <option value="118">118   PALAVECINO , EVER</option>
                            <option value="138">138   PAZ , GABRIEL</option>
                            <option value="103">103   PAZ , WALTER</option>
                            <option value="350">350   PERALTA , MATIAS</option>
                            <option value="133">133   PEREZ , JUAN</option>
                            <option value="431">431   PEREZ , HUGO</option>
                            <option value="495">495   PEREZ , CRISTIAN</option>
                            <option value="544">544   PEREYRA, ANGEL</option>
                            <option value="512">512   PEREYRA , DIEGO</option>
                            <option value="589">589   PEREYRA , HERNAN</option>
                            <option value="141">141   PETTERSEN , ANGEL</option>
                            <option value="591">591   POLO, Jonathan </option>
                            <option value="354">354   POBLETE , LISANDRO</option>
                            <option value="346">346   PORCEL , LUIS</option>
                            <option value="487">487   POVESI , CRISTIAN</option>
                            <option value="365">365   PRIETO , DAVID</option>
                            <option value="556">556   PUEBLAS, MARIO</option>
                            <option value="97">97    QUINTANA , HUGO</option>
                            <option value="282">282   QUIROGA , WALTER</option>
                            <option value="529">529   QUIROZ, GERMAN</option>
                            <option value="488">488   RAFFIN , SANTIAGO</option>
                            <option value="191">191   RAMIREZ , PABLO</option>
                            <option value="201">201   REINOSO , SERGIO</option>
                            <option value="115">115   RIOS , ORLANDO</option>
                            <option value="398">398   RIOS , GUILLERMO</option>
                            <option value="59">59    VARGAS , JORGE</option>
                            <option value="120">120   VARGAS , NELSON</option>
                            <option value="116">116   RIVADENEIRA , LUCIO</option>
                            <option value="67">67    RIVAS , HECTOR</option>
                            <option value="139">139   RODRIGUEZ , GARAY</option>
                            <option value="367">367   RODRIGUEZ , DIEGO</option>
                            <option value="379">379   RODRIGUEZ , ISIDRO</option>
                            <option value="571">571   RODRIGUEZ , SERGIO</option>
                            <option value="222">222   RODRIGUEZ , PABLO</option>
                            <option value="422">422   RODRIGUEZ , JONATAN</option>
                            <option value="471">471   ROJAS , JAVIER</option>
                            <option value="470">470   RUTELA, DAMIAN</option>
                            <option value="389">389   RUIZ , DAVID</option>
                            <option value="404">404   SANDOVAL , RODRIGO</option>
                            <option value="428">428   SANCHEZ , JAVIER</option>
                            <option value="94">94    SANCHEZ , WALTER</option>
                            <option value="173">173   SANCHEZ , JULIO</option>
                            <option value="267">267   SANCHEZ , RAUL</option>
                            <option value="584">584   SANCHEZ, FERNANDO</option>
                            <option value="473">473   SANCHEZ , LAUTARO</option>
                            <option value="237">237   SEGOVIA , SERGIO</option>
                            <option value="13">13    SAYAGO , ELENA</option>
                            <option value="357">357   SCARAFIA , ALEJANDRO</option>
                            <option value="19">19    SKUBIC , LUIS</option>
                            <option value="518">518   SICILIANO , GERMAN</option>
                            <option value="448">448   SORUCO , EDUARDO</option>
                            <option value="112">112   SOSA , DANIEL</option>
                            <option value="271">271   SUELDO , FRANCISCO</option>
                            <option value="198">198   SUAREZ , RICARDO</option>
                            <option value="362">362   TORRES , PASCUAL</option>
                            <option value="482">482   TORRES , CRISTIAN</option>
                            <option value="299">299   TRULLET , DANIEL</option>
                            <option value="130">130   TULA , JESUS</option>
                            <option value="1">1     TERCERO</option>
                            <option value="349">349   TEVES , LUIS</option>
                            <option value="332">332   TIVERON , JOSE</option>
                            <option value="447">447   VERA , GABRIEL</option>
                            <option value="348">348   VERA , OMAR</option>
                            <option value="156">156   VALERIO , HECTOR</option>
                            <option value="272">272   VALDEZ , JUAN</option>
                            <option value="107">107   VALLEJOS , JUAN</option>
                            <option value="59">59    VARGAS , JORGE</option>
                            <option value="291">291   VILLALBA , MANUEL</option>
                            <option value="51">51    VILLALBA , MARIO</option>
                            <option value="49">49    VILLALBA, SILVANO</option>
                            <option value="525">525   VIDELA , MARIANO</option>
                            <option value="586">586   ZAVALA , ESTEBAN</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="prioridad">Prioridad *</label>
                        <select id="prioridad" name="prioridad" required>
                            <option value="">Seleccionar prioridad</option>
                            <option value="low">Baja</option>
                            <option value="medium" selected>Media</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="fecha">Fecha</label>
                        <input type="date" id="fecha" name="fecha" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="sector">Sector</label>
                        <select id="sector" name="sector" required>
                            <option value="">Seleccionar sector</option>
                            <option value="corrugadora">Corrugadora</option>
                            <option value="ward_rdc">Ward RDC</option>
                            <option value="ward_ffg">Ward FFG</option>
                            <option value="c3000_rdc">C3000 RDC</option>
                            <option value="c2000">C2000</option>
                            <option value="cosedoras">Cosedoras</option>
                            <option value="gral_planta">Gral de Planta</option>
                            <option value="automotores">Automotores</option>
                            <option value="expedicion">Expedicion</option>
                            <option value="jumbo">Jumbo</option>
                        </select>
                    </div>
                </div>
                
                <div id="subEquipoContainer" class="sub-equipo-container">
                    <div class="form-group">
                        <label for="subEquipo">Sub-equipo</label>
                        <select id="subEquipo" name="subEquipo" required>
                            <option value="">Seleccionar sub-equipo</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="taller">Taller</label>
                        <select id="taller" name="taller" required>
                            <option value="">Seleccionar taller</option>
                            <option value="mecanico">Mecánico</option>
                            <option value="electrico">Eléctrico</option>
                            <option value="herreria">Herrería</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipoTarea">Tipo de tarea</label>
                        <select id="tipoTarea" name="tipoTarea" required>
                            <option value="">Seleccionar tipo</option>
                            <option value="mantenimiento">Mantenimiento</option>
                            <option value="seguridad">Seguridad</option>
                            <option value="mejora">Mejora</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="parte">Parte</label>
                    <input type="text" id="parte" name="parte" required>
                </div>
                
                <div class="form-group">
                    <label for="problema">Problema</label>
                    <textarea id="problema" name="problema" placeholder="Describa el problema detectado" required></textarea>
                </div>
                
                <div class="buttons-container">
                    <button type="button" id="cancelarNuevoBtn" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar Pedido</button>
                </div>
            </form>
        </div>
        
        <!-- Pantalla Búsqueda -->
        <div id="buscarScreen" class="screen">
            <h1>Buscar Pedido de Trabajo</h1>
            
            <form id="buscarForm">
                <div class="form-group">
                    <label for="pedidoIdBuscar">ID del Pedido</label>
                    <input type="text" id="pedidoIdBuscar" name="pedidoIdBuscar" placeholder="Ingrese el ID del pedido" required>
                </div>
                
                <div class="buttons-container">
                    <button type="button" id="cancelarBuscarBtn" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Buscar</button>
                </div>
            </form>
        </div>
        
        <!-- Pantalla Detalles del Pedido -->
        <div id="detalleScreen" class="screen">
            <h1>Detalles del Pedido</h1>
            
            <div class="pedido-info">
                <h2>Información del Pedido</h2>
                <div class="info-row">
                    <span class="info-label">ID:</span>
                    <span class="info-value" id="infoId"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Nombre:</span>
                    <span class="info-value" id="infoNombre"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Legajo:</span>
                    <span class="info-value" id="infoLegajo"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Fecha:</span>
                    <span class="info-value" id="infoFecha"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Sector:</span>
                    <span class="info-value" id="infoSector"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Sub-equipo:</span>
                    <span class="info-value" id="infoSubEquipo"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Taller:</span>
                    <span class="info-value" id="infoTaller"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tipo de tarea:</span>
                    <span class="info-value" id="infoTipoTarea"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Parte:</span>
                    <span class="info-value" id="infoParte"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Problema:</span>
                    <span class="info-value" id="infoProblema"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Estado:</span>
                    <span class="info-value" id="infoEstado"></span>
                </div>
                
                <div class="estado-selector">
                    <label for="nuevoEstado">Actualizar Estado:</label>
                    <select id="nuevoEstado">
                        <option value="abierto">Abierto</option>
                        <option value="proceso">En Proceso</option>
                        <option value="cerrado">Cerrado</option>
                    </select>
                    <button type="button" id="actualizarEstadoBtn" class="btn btn-purple btn-actualizar">Actualizar Estado</button>
                </div>
            </div>
            
            <div class="buttons-container">
                <button id="volverDetalleBtn" class="btn btn-secondary">Volver</button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    <div id="dbStatus" class="db-status">API: desconectada</div>
    
    <script>
        // --- API REST Flask ---
        const API_BASE = 'http://127.0.0.1:5000';

        function setApiStatus(text, bgColor) {
            const el = document.getElementById('dbStatus');
            if (!el) return;
            el.textContent = text;
            if (bgColor) {
                el.style.backgroundColor = bgColor;
            }
        }




        document.addEventListener('DOMContentLoaded', function() {
            // Elementos de la interfaz
            const mainScreen = document.getElementById('mainScreen');
            const nuevoPedidoScreen = document.getElementById('nuevoPedidoScreen');
            const buscarScreen = document.getElementById('buscarScreen');
            const detalleScreen = document.getElementById('detalleScreen');
            
            const nuevoPedidoBtn = document.getElementById('nuevoPedidoBtn');
            const buscarPedidoBtn = document.getElementById('buscarPedidoBtn');
            
            const cancelarNuevoBtn = document.getElementById('cancelarNuevoBtn');
            const cancelarBuscarBtn = document.getElementById('cancelarBuscarBtn');
            const volverDetalleBtn = document.getElementById('volverDetalleBtn');
            
            const pedidoForm = document.getElementById('pedidoForm');
            const buscarForm = document.getElementById('buscarForm');
            const actualizarEstadoBtn = document.getElementById('actualizarEstadoBtn');
            const nuevoEstadoSelect = document.getElementById('nuevoEstado');
            
            const pedidoIdElement = document.getElementById('pedidoId');
            const notification = document.getElementById('notification');
            const dbStatusElement = document.getElementById('dbStatus');
            
            // Elementos del formulario
            const sectorSelect = document.getElementById('sector');
            const subEquipoContainer = document.getElementById('subEquipoContainer');
            const subEquipoSelect = document.getElementById('subEquipo');
            
            // Variables de estado
            let pedidoActual = null;
            let db = null;
            let lastId = 79999; // ID inicial
            
            // Función para obtener el siguiente ID disponible
            async function fetchNextId() {
                // Obtener todos los tickets y calcular el siguiente ID
                try {
                    const res = await fetch(API_BASE + '/pedidos');
                    if (!res.ok) throw new Error('No se pudo obtener tickets');
                    const tickets = await res.json();
                    let maxId = tickets.reduce((max, t) => Math.max(max, parseInt(t.id)), 7999);
                    lastId = maxId;
                    pedidoIdElement.textContent = String(maxId + 1);
                    setApiStatus('API: conectada', 'rgba(46, 204, 113, 0.9)');
                } catch (e) {
                    lastId = 7999;
                    pedidoIdElement.textContent = String(lastId + 1);
                    setApiStatus('API: error de conexión', 'rgba(231, 76, 60, 0.9)');
                }
            }
            
            // Función para crear un nuevo pedido
            async function createPedido(pedido) {
                const solicitanteSelect = document.getElementById('solicitante');
                const selectedOption = solicitanteSelect ? solicitanteSelect.options[solicitanteSelect.selectedIndex] : null;
                const legajo = pedido.solicitante; // value del select
                // Extraer nombre desde el texto de la opción, quitando el legajo inicial
                const nombre = selectedOption ? selectedOption.textContent.replace(/^\s*\d+\s+/, '').trim() : String(legajo);

                const payload = {
                    nombre: nombre,
                    legajo: legajo,
                    fecha: pedido.fecha,
                    sector: pedido.sector,
                    subEquipo: pedido.subEquipo || null,
                    taller: pedido.taller,
                    tipoTarea: pedido.tipoTarea,
                    parte: pedido.parte,
                    problema: pedido.problema,
                    prioridad: pedido.prioridad,
                    estado: 'enviado' // Estado inicial
                };
                const res = await fetch(API_BASE + '/pedidos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || 'Error al crear pedido');
                }
                return res.json();
            }
            
            // Función para buscar un pedido por ID
            async function fetchPedidoById(id) {
                const res = await fetch(API_BASE + '/pedidos');
                if (!res.ok) return null;
                const tickets = await res.json();
                return tickets.find(t => String(t.id) === String(id)) || null;
            }
            
            // Función para actualizar el estado de un pedido
            async function updatePedidoEstado(id, estado) {
                const res = await fetch(API_BASE + '/pedidos/' + encodeURIComponent(id), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || 'Error al actualizar estado');
                }
                return res.json();
            }
            
            // Establecer fecha actual como valor predeterminado
            const fechaInput = document.getElementById('fecha');
            const today = new Date().toISOString().split('T')[0];
            fechaInput.value = today;
            
            // Función para mostrar notificaciones
            function showNotification(message, type = 'success') {
                notification.textContent = message;
                notification.className = 'notification show ' + type;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            // Función para cambiar de pantalla
            function showScreen(screenName) {
                // Ocultar todas las pantallas
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                
                // Mostrar la pantalla seleccionada
                document.getElementById(screenName).classList.add('active');
            }
            
            // Datos de sub-equipos por sector
            const subEquiposPorSector = {
                'corrugadora': [
                    'Apilador inferior', 'Apilador superior', 'Cabezal 1', 'Cabezal 2', 'Cabezal 3',
                    'Caldera', 'Colero triple', 'Mesa de secado', 'Dual shear', 'Guillotina master',
                    'Sistema de aire comprimido', 'Retorno condensado', 'Sistema de extraccion de refile',
                    'Twin 400', 'Cinta transportadora', 'Empalmador', 'Precalentador', 'Servicio externo'
                ],
                'ward_rdc': [
                    'Accustak', 'Atadora mosca AO5', 'Atadora mosca AO6', 'Atadora transpack',
                    'Cuerpo n1', 'Cuerpo n2', 'Cuerpo n3', 'Cuerpo n4', 'Cuerpos impresores',
                    'Despaletizador', 'Feed max', 'Introductor', 'Load master', 'Sistema de aire comprimido',
                    'Sistema electrico', 'Sistema de lavado', 'Servicio externo', 'Sistema de extraccion de refile',
                    'Transportadores de bancales', 'Transportadores de entrada', 'Transportadores de paquetes', 'Troquelador'
                ],
                'ward_ffg': [
                    'Atadora mosca AO3', 'Atadora mosca AO4', 'Atadora mosca AO5', 'Colero',
                    'Counter ejector', 'Cuerpo n1', 'Cuerpo n2', 'Cuerpo n3', 'Cuerpo n4',
                    'Cuerpos impresores', 'Despaletizador', 'Feed max', 'Introductor', 'Load master',
                    'Plegador', 'Slotter', 'Sistema electrico', 'Sistema de extraccion de refile',
                    'Servicio externo', 'Transportadores bancales', 'Transportadores de entrada', 'Transportadores de paquetes', 'Troquelador'
                ],
                'c3000_rdc': [
                    'Atadora mosca', 'Atadora transpack', 'Atadora mosca AO5', 'Cuerpo n1',
                    'Cuerpo n2', 'Cuerpo n3', 'Cuerpo n4', 'Cuerpo n5', 'Cuerpos impresores',
                    'Despaletizador', 'Expedicion', 'Feed master', 'Introductor', 'Loadmaster',
                    'Servicio de aire comprimido', 'Servicio externo', 'Sistema de extraccion de refile',
                    'Sistema electrico', 'Stacker geomartin', 'Transportadores bancales', 'Transportadores de entrada',
                    'Transportadores paquetes', 'Troquelador'
                ],
                'c2000': [
                    'Atadora mosca AO3', 'Atadora mosca AO4', 'Atadora mosca AO5', 'Colero',
                    'Counter ejector', 'Cuerpo n1', 'Cuerpo n2', 'Cuerpo 3', 'Cuerpo n4',
                    'Cuerpos impresores', 'Despaletizador', 'Expedicion', 'Feed master', 'Introductor',
                    'Loadmaster', 'Plegador', 'Servicio aire comprimido', 'Servicio externo',
                    'Sistema electrico', 'Sistema extraccion de refile', 'Slotter', 'Transportadores de bancales',
                    'Transportadores de entrada', 'Transportadores paquetes'
                ],
                'cosedoras': [
                    'Bahmuller n1', 'Bahmuller n2', 'Bahmuller n3'
                ],
                'gral_planta': [
                    'Balanza de camiones', 'Baños', 'Baños exterior', 'Caldera', 'Calle de camiones',
                    'Camara de rebaje de gas', 'Camaras de seguridad', 'Cargador de baterias Hyundai',
                    'Cargador de baterias Toyota', 'Carro brazo', 'Carro NE', 'Carro tijera', 'Comedor',
                    'Compresores', 'Sector corrugadora', 'Cosedoras', 'Deposito de bobinas',
                    'Deposito de tintas', 'Dispenser', 'Enfardadora', 'Entrepiso', 'Estibadora',
                    'Extractan de refile', 'Galpon', 'Grabados', 'Grupo electrogeno', 'Impresoras generales',
                    'Sector jumbo', 'Sector laboratorio', 'Lavadero autoelevadores', 'Luces de emergencia',
                    'Montacargas "grabados"', 'Oficina expedicion', 'Oficina gerencia', 'Oficina produccion',
                    'Ofician diseño y desarrollo', 'Oficina tecnica', 'Oficina de ventas', 'Oficinas de administracion',
                    'P.A.T', 'Pañol', 'Perimetro exterior', 'Porton ingreso', 'Puertas red de agua',
                    'Red de gas', 'Red de incendio', 'Sala de bombas', 'Sala transformadores',
                    'Sala capacitacitacion', 'Sector troqueles', 'Sendas peatonales', 'Servicios',
                    'Tablero general', 'Taller automotores', 'Taller herreria', 'Taller electrico',
                    'Taller mecanico', 'Tanque principal de agua', 'Techo de planta', 'Tratamiento de afluentes',
                    'Ventiladores', 'Vestuarios', 'Vigilancia', 'Sistema de aire comprimido'
                ],
                'automotores': [
                    'Back-up', 'Carro pluma', 'Carro tijera', 'Caterpillar', 'Desmalezadora Honda 450 n3',
                    'Desmalezadora Honda 450 n4', 'Hyundai n24', 'Hyundai n25', 'Maximal n13', 'Sprinter 310',
                    'Sprinter 415', 'Sprinter 96', 'Tanque combustible', 'TCM FD 25 andino', 'TCM FD 25 n10',
                    'TCM FD 25 n2', 'TCM FD 25 n25', 'TCM FD 25 n7', 'TCM FD 25 n8', 'TCM FD 25 n9',
                    'TCM FD 45 n11', 'TCM FD 45 n12', 'TCM FD 45 n14', 'TCM FD 45 n25', 'TCM FD 45 n27',
                    'TCM FD 45 n3', 'TCM FD 45 n4', 'TCM n15', 'Toyota 16', 'Toyota 17', 'Toyota 18',
                    'Toyota 19', 'Toyota 20', 'Toyota 21', 'Toyota 22', 'Toyota 23'
                ],
                'expedicion': [
                    'Carro n.e', 'Cinta tranportadora', 'Cortinas', 'Mete pallets', 'Rodillera',
                    'Strechadora blanca', 'Strechadora MEGA', 'Zunchadora mosca'
                ],
                'jumbo': [
                    'Apilador', 'Cuerpo n1', 'Cuerpo n2', 'Cuerpos impresores', 'Introductor',
                    'Servicio aire comprimido', 'Servicio externo', 'Sistema electrico',
                    'Sistema extraccion refile', 'Slotter 1', 'Slotter 2', 'Stacker',
                    'Transportadores entradas', 'Transportadores paquetes', 'Troquelador'
                ]
            };
            
            // Evento para cambiar el sector
            sectorSelect.addEventListener('change', function() {
                const sector = sectorSelect.value;
                
                // Limpiar el selector de sub-equipo
                subEquipoSelect.innerHTML = '<option value="">Seleccionar sub-equipo</option>';
                
                if (sector && subEquiposPorSector[sector]) {
                    // Mostrar el contenedor de sub-equipo
                    subEquipoContainer.classList.add('show');
                    
                    // Agregar las opciones de sub-equipo
                    subEquiposPorSector[sector].forEach(subEquipo => {
                        const option = document.createElement('option');
                        option.value = subEquipo.toLowerCase().replace(/\s+/g, '_');
                        option.textContent = subEquipo;
                        subEquipoSelect.appendChild(option);
                    });
                } else {
                    // Ocultar el contenedor de sub-equipo
                    subEquipoContainer.classList.remove('show');
                }
            });
            
            // (Se elimina configuración duplicada de API y funciones repetidas)
            
            // Eventos para cambiar de pantalla
            nuevoPedidoBtn.addEventListener('click', function() {
                // Generar nuevo ID
                pedidoIdElement.textContent = lastId + 1;
                showScreen('nuevoPedidoScreen');
            });
            
            buscarPedidoBtn.addEventListener('click', function() {
                showScreen('buscarScreen');
            });
            
            cancelarNuevoBtn.addEventListener('click', function() {
                if (confirm('¿Estás seguro de que deseas cancelar? Los datos no guardados se perderán.')) {
                    pedidoForm.reset();
                    fechaInput.value = today;
                    subEquipoContainer.classList.remove('show');
                    showScreen('mainScreen');
                }
            });
            
            cancelarBuscarBtn.addEventListener('click', function() {
                buscarForm.reset();
                showScreen('mainScreen');
            });
            
            volverDetalleBtn.addEventListener('click', function() {
                showScreen('mainScreen');
            });
            
            // Evento para enviar el formulario de nuevo pedido
            pedidoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Obtener datos del formulario
                const formData = new FormData(pedidoForm);
                const pedidoData = {};
                
                for (let [key, value] of formData.entries()) {
                    pedidoData[key] = value;
                }
                
                // Guardar a través de la API
                createPedido(pedidoData)
                    .then(({ id }) => {
                        showNotification('¡Pedido guardado correctamente! ID: ' + id, 'success');
                        pedidoForm.reset();
                        fechaInput.value = today;
                        subEquipoContainer.classList.remove('show');
                        // refrescar next id
                        fetchNextId().catch(() => {});
                        setTimeout(() => {
                            showScreen('mainScreen');
                        }, 1500);
                    })
                    .catch(err => {
                        console.error(err);
                        showNotification(err.message || 'Error al guardar el pedido', 'error');
                    });
            });
            
            // Evento para buscar el pedido
            buscarForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const pedidoId = document.getElementById('pedidoIdBuscar').value;
                
                // Buscar el pedido por ID en la API
                fetchPedidoById(pedidoId)
                    .then(pedido => {
                        if (pedido) {
                            // Guardar el pedido actual para referencia
                            pedidoActual = pedido;
                            
                            // Mostrar la información del pedido
                            document.getElementById('infoId').textContent = pedido.id;
                            document.getElementById('infoNombre').textContent = pedido.nombre;
                            document.getElementById('infoLegajo').textContent = pedido.legajo;
                            document.getElementById('infoFecha').textContent = pedido.fecha;
                            document.getElementById('infoSector').textContent = getSectorTexto(pedido.sector);
                            document.getElementById('infoSubEquipo').textContent = getSubEquipoTexto(pedido.sector, pedido.subEquipo);
                            document.getElementById('infoTaller').textContent = getTallerTexto(pedido.taller);
                            document.getElementById('infoTipoTarea').textContent = getTipoTareaTexto(pedido.tipoTarea);
                            document.getElementById('infoParte').textContent = pedido.parte;
                            document.getElementById('infoProblema').textContent = pedido.problema;
                            
                            // Mostrar el estado con un badge
                            const estadoElement = document.getElementById('infoEstado');
                            estadoElement.innerHTML = '';
                            const badge = document.createElement('span');
                            
                            // Si el pedido no tiene estado, le asignamos "abierto" por defecto
                            const estado = pedido.estado || 'abierto';
                            
                            badge.className = 'estado-badge estado-' + estado;
                            badge.textContent = getEstadoTexto(estado);
                            estadoElement.appendChild(badge);
                            
                            // Establecer el estado actual en el selector
                            nuevoEstadoSelect.value = estado;
                            
                            // Mostrar la pantalla de detalles
                            showScreen('detalleScreen');
                            
                            showNotification('Pedido encontrado', 'success');
                        } else {
                            showNotification('No se encontró un pedido con ese ID', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error al buscar el pedido:', error);
                        showNotification('Error al buscar el pedido', 'error');
                    });
            });
            
            // Evento para actualizar el estado
            actualizarEstadoBtn.addEventListener('click', function() {
                if (!pedidoActual) return;
                
                const nuevoEstado = nuevoEstadoSelect.value;
                
                // Actualizar el estado del pedido
                pedidoActual.estado = nuevoEstado;
                updatePedidoEstado(pedidoActual.id, nuevoEstado)
                    .then(() => {
                        // Actualizar el badge de estado
                        const estadoElement = document.getElementById('infoEstado');
                        estadoElement.innerHTML = '';
                        const badge = document.createElement('span');
                        badge.className = 'estado-badge estado-' + nuevoEstado;
                        badge.textContent = getEstadoTexto(nuevoEstado);
                        estadoElement.appendChild(badge);
                        showNotification('Estado actualizado correctamente', 'success');
                    })
                    .catch(err => {
                        console.error(err);
                        showNotification(err.message || 'Error al actualizar el estado', 'error');
                    });
            });
            
            // Función para obtener el texto del estado
            function getEstadoTexto(estado) {
                const estados = {
                    'abierto': 'Abierto',
                    'proceso': 'En Proceso',
                    'cerrado': 'Cerrado'
                };
                return estados[estado] || estado;
            }
            
            // Función para obtener el texto del sector
            function getSectorTexto(sector) {
                const sectores = {
                    'corrugadora': 'Corrugadora',
                    'ward_rdc': 'Ward RDC',
                    'ward_ffg': 'Ward FFG',
                    'c3000_rdc': 'C3000 RDC',
                    'c2000': 'C2000',
                    'cosedoras': 'Cosedoras',
                    'gral_planta': 'Gral de Planta',
                    'automotores': 'Automotores',
                    'expedicion': 'Expedicion',
                    'jumbo': 'Jumbo'
                };
                return sectores[sector] || sector;
            }
            
            // Función para obtener el texto del sub-equipo
            function getSubEquipoTexto(sector, subEquipo) {
                if (!sector || !subEquipo) return '';
                
                // Buscar el sub-equipo en la lista correspondiente al sector
                if (subEquiposPorSector[sector]) {
                    const subEquipoObj = subEquiposPorSector[sector].find(
                        item => item.toLowerCase().replace(/\s+/g, '_') === subEquipo
                    );
                    return subEquipoObj || subEquipo;
                }
                
                return subEquipo;
            }
            
            // Función para obtener el texto del taller
            function getTallerTexto(taller) {
                const talleres = {
                    'mecanico': 'Mecánico',
                    'electrico': 'Eléctrico',
                    'herreria': 'Herrería',
                    'otros': 'Otros'
                };
                return talleres[taller] || taller;
            }
            
            // Función para obtener el texto del tipo de tarea
            function getTipoTareaTexto(tipoTarea) {
                const tipos = {
                    'mantenimiento': 'Mantenimiento',
                    'seguridad': 'Seguridad',
                    'mejora': 'Mejora'
                };
                return tipos[tipoTarea] || tipoTarea;
            }
            
            // Inicializar API y obtener próximo ID
            setApiStatus('API: conectando...', 'rgba(241, 196, 15, 0.9)');
            fetchNextId();
        });
    </script>
</body>
</html>